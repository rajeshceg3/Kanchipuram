import { test, expect } from '@playwright/test';
import AxeBuilder from '@axe-core/playwright';

test.describe('Tactical Vulnerability Assessment', () => {
  test('Security & Integrity Scan', async ({ page }) => {
    const consoleErrors = [];
    const failedRequests = [];

    page.on('console', msg => {
      if (msg.type() === 'error' || msg.type() === 'warning') {
        consoleErrors.push(`[${msg.type().toUpperCase()}] ${msg.text()}`);
      }
    });

    page.on('requestfailed', request => {
      failedRequests.push(`${request.url()} - ${request.failure().errorText}`);
    });

    await page.goto('/');

    // Check for mixed content (resources loaded over HTTP), ignoring localhost
    const mixedContent = await page.evaluate(() => {
      return Array.from(performance.getEntriesByType('resource'))
        .filter(r => r.name.startsWith('http://') && !r.name.includes('localhost') && !r.name.includes('127.0.0.1'))
        .map(r => r.name);
    });

    // Verify Title
    await expect(page).toHaveTitle(/Kanchipuram/);

    // Wait for map
    await expect(page.locator('#map')).toBeVisible();

    // Log findings
    console.log('--- SECURITY FINDINGS ---');
    if (mixedContent.length > 0) console.log('Mixed Content Detected:', mixedContent);
    if (consoleErrors.length > 0) console.log('Console Errors:', consoleErrors);
    if (failedRequests.length > 0) console.log('Failed Requests:', failedRequests);

    // Assertions to fail the test if critical issues found
    // We expect NO mixed content
    expect(mixedContent, 'Mixed Content should be zero').toHaveLength(0);
  });

  test('Accessibility Audit', async ({ page }) => {
    await page.goto('/');
    await page.waitForSelector('#temple-list li'); // Wait for content

    const accessibilityScanResults = await new AxeBuilder({ page })
        .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
        .analyze();

    console.log('--- ACCESSIBILITY FINDINGS ---');
    if (accessibilityScanResults.violations.length > 0) {
        console.log(`Found ${accessibilityScanResults.violations.length} accessibility violations:`);
        accessibilityScanResults.violations.forEach(v => {
            console.log(`- [${v.impact}] ${v.help}: ${v.helpUrl}`);
            v.nodes.forEach(n => console.log(`  Target: ${n.target}`));
        });
    }

    // We aim for 0 violations, but let's see.
    // Uncommenting to strict fail
    // expect(accessibilityScanResults.violations).toEqual([]);
  });

  test('Performance & UX Stress Test', async ({ page }) => {
    await page.goto('/');

    // Check Load Time
    const performanceTiming = await page.evaluate(() => JSON.stringify(window.performance.timing));
    // console.log('Performance:', performanceTiming);

    // Interaction: Toggle Panel
    const panel = page.locator('#panel');
    const toggle = page.locator('#panel-toggle');

    // Mobile Viewport Simulation
    await page.setViewportSize({ width: 375, height: 667 });
    await expect(toggle).toBeVisible();
    // Wait for panel to settle (animation)
    await page.waitForTimeout(1500);

    // Check List Interaction - Ensure panel is visible before clicking
    // On mobile, panel might be open or closed. If closed, open it.
    const panelClasses = await panel.getAttribute('class');
    if (panelClasses && panelClasses.includes('hidden-mobile')) {
        await toggle.click();
        await page.waitForTimeout(1000);
    }

    const firstItem = page.locator('#temple-list li').first();
    // Ensure element is ready
    await firstItem.waitFor({ state: 'visible' });
    await firstItem.click();

    // Check Map Popup
    const popup = page.locator('.leaflet-popup-content');
    await expect(popup).toBeVisible();
  });

  test('Resilience Check (Offline Simulation)', async ({ page, context }) => {
      await page.goto('/');
      await context.setOffline(true);

      // Reload should fail if no PWA
      try {
        await page.reload();
        const title = await page.title();
        console.log('Offline Reload Title:', title);
      } catch (e) {
          console.log('Offline Reload Failed as expected (No PWA yet)');
      }
  });
});
